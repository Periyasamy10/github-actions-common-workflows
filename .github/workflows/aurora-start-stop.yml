name: Aurora start and stop

on:
  workflow_call:
    inputs:
      action:
        required: true
        type: string
      cluster_name:
        required: true
        type: string
      aws_region:
        required: true
        type: string
    secrets:
      role_to_assume:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  start_stop:
    if: inputs.action == 'start' || inputs.action == 'stop'
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.role_to_assume }}
          aws-region: ${{ inputs.aws_region }}

      - name: Get Current Cluster Status
        id: status
        run: |
          STATUS=$(aws rds describe-db-clusters \
            --db-cluster-identifier ${{ inputs.cluster_name }} \
            --query 'DBClusters[0].Status' \
            --output text)

          echo "Current status: $STATUS"
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Start or Stop Cluster
        run: |
          ACTION="${{ inputs.action }}"
          CLUSTER="${{ inputs.cluster_name }}"
      
          echo "Requested action: $ACTION"
      
          # Function to get cluster status
          get_status () {
            aws rds describe-db-clusters \
              --db-cluster-identifier $CLUSTER \
              --query 'DBClusters[0].Status' \
              --output text
          }
      
          CURRENT_STATUS=$(get_status)
          echo "Current status: $CURRENT_STATUS"
      
          # Exit if already in desired state
          if [ "$ACTION" = "start" ] && [ "$CURRENT_STATUS" = "available" ]; then
            echo "Cluster already running. Exiting."
            exit 0
          fi
      
          if [ "$ACTION" = "stop" ] && [ "$CURRENT_STATUS" = "stopped" ]; then
            echo "Cluster already stopped. Exiting."
            exit 0
          fi
      
          # Trigger action
          if [ "$ACTION" = "start" ]; then
            echo "Starting cluster..."
            aws rds start-db-cluster --db-cluster-identifier $CLUSTER
            TARGET_STATE="available"
          else
            echo "Stopping cluster..."
            aws rds stop-db-cluster --db-cluster-identifier $CLUSTER
            TARGET_STATE="stopped"
          fi
      
          echo "Waiting for cluster to reach state: $TARGET_STATE"
      
          # Wait loop with timeout (20 minutes)
          MAX_ATTEMPTS=60   # 60 x 20s = 20 minutes
          ATTEMPT=0
      
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS=$(get_status)
            echo "Current status: $STATUS"
      
            if [ "$STATUS" = "$TARGET_STATE" ]; then
              echo "Cluster reached target state: $TARGET_STATE"
              exit 0
            fi
      
            sleep 20
            ATTEMPT=$((ATTEMPT+1))
          done
      
          echo "Timeout waiting for cluster to reach $TARGET_STATE"
          exit 1
      
      - name: Show Final Status
        run: |
          aws rds describe-db-clusters \
            --db-cluster-identifier ${{ inputs.cluster_name }} \
            --query 'DBClusters[0].Status' \
            --output text
  
  single_az_failure:
    if: inputs.action == 'single-az-failure'
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.role_to_assume }}
          aws-region: ${{ inputs.aws_region }}

      - name: Capture Current Writer + AZ
        id: before
        run: |
          CLUSTER=${{ inputs.cluster_name }}

          WRITER=$(aws rds describe-db-clusters \
            --db-cluster-identifier $CLUSTER \
            --query 'DBClusters[0].DBClusterMembers[?IsClusterWriter==`true`].DBInstanceIdentifier' \
            --output text)

          AZ=$(aws rds describe-db-instances \
            --db-instance-identifier $WRITER \
            --query 'DBInstances[0].AvailabilityZone' \
            --output text)

          echo "Current writer: $WRITER"
          echo "Current writer AZ: $AZ"

          echo "writer=$WRITER" >> $GITHUB_OUTPUT
          echo "az=$AZ" >> $GITHUB_OUTPUT

      - name: Force Failover
        run: |
          aws rds failover-db-cluster \
            --db-cluster-identifier ${{ inputs.cluster_name }}

      - name: Wait for Promotion
        run: |
          CLUSTER=${{ inputs.cluster_name }}
          OLD_WRITER="${{ steps.before.outputs.writer }}"
          OLD_AZ="${{ steps.before.outputs.az }}"

          echo "Waiting for new writer..."

          for i in {1..30}; do
            NEW_WRITER=$(aws rds describe-db-clusters \
              --db-cluster-identifier $CLUSTER \
              --query 'DBClusters[0].DBClusterMembers[?IsClusterWriter==`true`].DBInstanceIdentifier' \
              --output text)

            if [ "$NEW_WRITER" != "$OLD_WRITER" ]; then
              break
            fi

            sleep 10
          done

          NEW_AZ=$(aws rds describe-db-instances \
            --db-instance-identifier $NEW_WRITER \
            --query 'DBInstances[0].AvailabilityZone' \
            --output text)

          echo ""
          echo "❌ Failed AZ: $OLD_AZ"
          echo "✅ Promoted AZ: $NEW_AZ"
          echo "Old Writer: $OLD_WRITER"
          echo "New Writer: $NEW_WRITER"

          if [ "$NEW_WRITER" = "$OLD_WRITER" ]; then
            echo "Failover did NOT occur!"
            exit 1
          fi

  two_az_failure:
    if: inputs.action == 'two-az-failure'
    runs-on: ubuntu-latest
  
    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.role_to_assume }}
          aws-region: ${{ inputs.aws_region }}
  
      - name: Capture Writer + Reader + AZs
        id: before
        run: |
          CLUSTER=${{ inputs.cluster_name }}
  
          WRITER=$(aws rds describe-db-clusters \
            --db-cluster-identifier $CLUSTER \
            --query 'DBClusters[0].DBClusterMembers[*].[DBInstanceIdentifier,IsClusterWriter]' \
            --output text | awk '$2=="True" {print $1}')
  
          READER=$(aws rds describe-db-clusters \
            --db-cluster-identifier $CLUSTER \
            --query 'DBClusters[0].DBClusterMembers[*].[DBInstanceIdentifier,IsClusterWriter]' \
            --output text | awk '$2=="False" {print $1; exit}')
  
          if [ -z "$WRITER" ] || [ -z "$READER" ]; then
            echo "Cluster must have at least 1 writer and 1 reader."
            exit 1
          fi
  
          WRITER_AZ=$(aws rds describe-db-instances \
            --db-instance-identifier $WRITER \
            --query 'DBInstances[0].AvailabilityZone' \
            --output text)
  
          READER_AZ=$(aws rds describe-db-instances \
            --db-instance-identifier $READER \
            --query 'DBInstances[0].AvailabilityZone' \
            --output text)
  
          echo "Writer: $WRITER ($WRITER_AZ)"
          echo "Reader to delete: $READER ($READER_AZ)"
  
          echo "writer=$WRITER" >> $GITHUB_OUTPUT
          echo "reader=$READER" >> $GITHUB_OUTPUT
          echo "writer_az=$WRITER_AZ" >> $GITHUB_OUTPUT
          echo "reader_az=$READER_AZ" >> $GITHUB_OUTPUT
  
      - name: Trigger Aurora Failover (Writer AZ Failure)
        run: |
          echo "Triggering cluster failover..."
          aws rds failover-db-cluster \
            --db-cluster-identifier ${{ inputs.cluster_name }}
  
      - name: Delete One Reader (Simulate Second AZ Failure)
        run: |
          echo "Deleting reader instance to simulate second AZ failure..."
          aws rds delete-db-instance \
            --db-instance-identifier ${{ steps.before.outputs.reader }} \
            --skip-final-snapshot
  
      - name: Wait for New Writer Promotion
        run: |
          CLUSTER=${{ inputs.cluster_name }}
          OLD_WRITER="${{ steps.before.outputs.writer }}"
          OLD_WRITER_AZ="${{ steps.before.outputs.writer_az }}"
          FAILED_READER_AZ="${{ steps.before.outputs.reader_az }}"
  
          echo "Waiting for promotion..."
  
          for i in {1..40}; do
            NEW_WRITER=$(aws rds describe-db-clusters \
              --db-cluster-identifier $CLUSTER \
              --query 'DBClusters[0].DBClusterMembers[?IsClusterWriter==`true`].DBInstanceIdentifier' \
              --output text)
  
            if [ "$NEW_WRITER" != "$OLD_WRITER" ]; then
              break
            fi
  
            sleep 10
          done
  
          if [ "$NEW_WRITER" = "$OLD_WRITER" ]; then
            echo "Failover did NOT occur!"
            exit 1
          fi
  
          NEW_AZ=$(aws rds describe-db-instances \
            --db-instance-identifier $NEW_WRITER \
            --query 'DBInstances[0].AvailabilityZone' \
            --output text)
  
          echo ""
          echo "❌ Failed Writer AZ: $OLD_WRITER_AZ"
          echo "❌ Failed Reader AZ: $FAILED_READER_AZ"
          echo "✅ Promoted Writer AZ: $NEW_AZ"
          echo "New Writer Instance: $NEW_WRITER"